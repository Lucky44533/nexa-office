<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexa Calc</title>
<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

header {
    background-color: #2c3e50;
    color: white;
    padding: 15px;
    text-align: center;
}

#toolbar {
    display: flex;
    flex-wrap: wrap;
    background-color: #ecf0f1;
    padding: 10px;
    gap: 8px;
    border-bottom: 1px solid #ccc;
    align-items: center;
}

#toolbar button, #toolbar input, #toolbar select {
    border: none;
    background-color: #2980b9;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
}

#toolbar button:hover, #toolbar select:hover, #toolbar input:hover {
    background-color: #1c5980;
}

#spreadsheet {
    flex: 1;
    overflow: auto;
    margin: 0;
}

table {
    border-collapse: collapse;
    width: 100%;
}

td, th {
    border: 1px solid #ccc;
    min-width: 80px;
    height: 25px;
    padding: 2px;
    text-align: left;
}

td {
    cursor: pointer;
}

input.cell-input {
    width: 100%;
    height: 100%;
    border: none;
    padding: 0 2px;
    box-sizing: border-box;
}

</style>
</head>
<body>

<header>
    <h1>Nexa Calc</h1>
</header>

<div id="toolbar">
    <button onclick="addRow()">âž• Ligne</button>
    <button onclick="addCol()">âž• Colonne</button>
    <button onclick="exportCSV()">ðŸ’¾ CSV</button>
    <button onclick="exportPDF()">ðŸ’¾ PDF</button>
    <label>A4 :
        <input type="checkbox" id="a4Toggle" checked>
    </label>
</div>

<div id="spreadsheet">
    <table id="sheet">
        <thead>
            <tr id="headerRow">
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const table = document.getElementById('sheet').getElementsByTagName('tbody')[0];
const headerRow = document.getElementById('headerRow');

let cols = 5;
let rows = 10;

// CrÃ©ation du tableau initial
function initSheet() {
    headerRow.innerHTML = '<th></th>';
    for(let c=0;c<cols;c++){
        headerRow.innerHTML += `<th>${String.fromCharCode(65+c)}</th>`;
    }
    table.innerHTML = '';
    for(let r=1;r<=rows;r++){
        addRow(false);
    }
}

function addRow(update=true) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>${table.rows.length+1}</th>`;
    for(let c=0;c<cols;c++){
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.className = 'cell-input';
        input.onblur = () => computeCell(input);
        td.appendChild(input);
        tr.appendChild(td);
    }
    table.appendChild(tr);
}

function addCol() {
    cols++;
    headerRow.innerHTML += `<th>${String.fromCharCode(64+cols)}</th>`;
    Array.from(table.rows).forEach(row => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.className = 'cell-input';
        input.onblur = () => computeCell(input);
        td.appendChild(input);
        row.appendChild(td);
    });
}

function computeCell(input){
    const val = input.value;
    if(val.startsWith('=')){
        try{
            const formula = val.slice(1).replace(/[A-Z]+[0-9]+/g, s => {
                const col = s.charCodeAt(0)-65;
                const row = parseInt(s.slice(1))-1;
                const cell = table.rows[row].cells[col].firstChild.value;
                return cell || 0;
            });
            input.value = eval(formula);
        } catch(e){ console.error(e); }
    }
}

function exportCSV(){
    let csv = '';
    const headers = Array.from(headerRow.cells).map(th => th.innerText).join(';');
    csv += headers+'\n';
    Array.from(table.rows).forEach(row => {
        const rowData = Array.from(row.cells).slice(1).map(td => td.firstChild.value).join(';');
        csv += rowData+'\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'NexaCalc.csv';
    a.click();
}

function exportPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
        orientation: document.getElementById('a4Toggle').checked ? 'portrait' : 'landscape',
        unit: 'cm',
        format: 'a4'
    });
    pdf.html(document.getElementById('sheet'), {
        callback: function(doc){ doc.save('NexaCalc.pdf'); },
        x: 1, y: 1
    });
}

initSheet();
</script>

</body>
</html>
